<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <title>教職員請假 Leave Form</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body {
            font-family: Arial, "PingFang TC", "Microsoft JhengHei", sans-serif;
            padding: 20px;
        }

        h1 {
            color: rgb(30, 46, 94);
        }

        .title {
            font-weight: bold;
            font-size: 1.2rem;
            color: rgb(30, 46, 94);
        }

        .content {
            font-weight: normal;
            font-size: 1rem;
        }

        .date-time-group {
            margin: 10px 0;
        }

        input[type="text"],
        input[type="email"],
        input[type="file"],
        input[type="date"],
        textarea {
            margin: 5px 0;
            padding: 5px;
            width: 250px;
        }

        .time-input {
            width: 120px;
        }

        .muted {
            color: #666;
            font-size: 0.95rem;
            margin: 6px 0 10px;
        }

        /* 浮層樣式 */
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        #modal {
            background: white;
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            text-align: center;
            width: 400px;
        }
    </style>
</head>

<body>
    <h1>請假表 Leave Form</h1>
    <form id="leaveForm">
        <!-- 基本資料 -->
        <fieldset>
            <legend class="title">姓名 Name</legend>
            <input type="text" name="name" required>
        </fieldset>

        <fieldset>
            <legend class="title">電子郵件 Email Address</legend>
            <input type="email" name="email" placeholder="example@school.edu.tw" required>
        </fieldset>

        <!-- 請假類型 -->
        <fieldset>
            <legend class="title">請假類型 Leave Type</legend>
            <label class="content"><input type="radio" name="leaveType" value="Annual Leave"> 特休假 Annual
                Leave</label><br>
            <label class="content"><input type="radio" name="leaveType" value="Personal Leave"> 事假 Personal
                Leave</label><br>
            <label class="content"><input type="radio" name="leaveType" value="Sick Leave"> 病假 Sick Leave</label><br>
            <label class="content"><input type="radio" name="leaveType" value="Official Leave"> 公假 Official
                Leave</label><br>
            <label class="content">
                <input type="radio" name="leaveType" value="Other"> 其他 Other:
                <input type="text" name="leaveTypeOther" placeholder="請輸入"
                    style="border-bottom: 1px solid #ccc; border-top: none; border-left: none; border-right: none; outline: none;">
            </label>
        </fieldset>

        <!-- 理由 -->
        <fieldset>
            <legend class="title">請假理由 Reason</legend>
            <textarea name="reason" rows="3" required></textarea>
        </fieldset>

        <!-- 證明文件 -->
        <fieldset>
            <legend class="title">證明文件 Supporting Document</legend>
            <p class="content">可上傳圖片或 PDF (最大 2MB)<br>Upload image or PDF files (max 2MB)</p>
            <input type="file" name="attachment" accept=".jpg,.jpeg,.png,.pdf" id="fileInput">
        </fieldset>

        <!-- 日期與時間 -->
        <fieldset>
            <legend class="title">請假日期與時間 Leave Dates & Time</legend>
            <p class="content">請先選擇請假型態 Please select leave type：</p>
            <label class="content"><input type="radio" name="leaveSpanType" value="full" id="leaveFullRadio"> 全天 Full
                Day</label>
            <label class="content" style="margin-left:12px;"><input type="radio" name="leaveSpanType" value="partial"
                    id="leavePartialRadio"> 部分時段 Partial Day</label>

            <p class="muted" id="dateHint" style="display:none;">
                可選擇多個不連續的請假日期。Multiple non-adjacent leave dates can be selected.
            </p>

            <input type="text" id="multiDatePicker" name="leaveDates" placeholder="請選擇日期" readonly
                style="display:none;">
            <div id="dateTimeFields"></div>
        </fieldset>

        <!-- 職稱 -->
        <fieldset>
            <legend class="title">職稱 Position</legend>
            <label class="content"><input type="radio" name="position" value="Teacher" onclick="toggleAgentSection()">
                教師
                Teacher</label><br>
            <label class="content"><input type="radio" name="position" value="Admin Staff"
                    onclick="toggleAgentSection()"> 行政人員 Admin Staff</label>
        </fieldset>

        <!-- 教師部分 -->
        <div id="teacherSection" style="display:none">
            <fieldset>
                <legend class="title">是否需調/代課? Reschedule/Arrange Sub?</legend>
                <label class="content"><input type="radio" name="subOption" value="No Need"
                        onclick="toggleSubOptions()"> 不需要 No
                    Need</label><br>
                <label class="content"><input type="radio" name="subOption" value="Reschedule"
                        onclick="toggleSubOptions()"> 調課 Reschedule the Class</label><br>
                <label class="content"><input type="radio" name="subOption" value="Sub Teacher"
                        onclick="toggleSubOptions()"> 代課 Arrange a Sub Teacher</label>
            </fieldset>

            <div id="rescheduleSection" style="display:none">
                <p>填寫調課時段（科目、日期與時間）<br>
                    Complete the details of the rescheduled class (subject and period(s))</p>
                <input type="text" name="rescheduleInfo" placeholder="Subject, Date, Time">
            </div>

            <div id="subTeacherSection" style="display:none">
                代課者姓名 Cover Teacher’s Name: <input type="text" name="subName"><br>
                代課時段 Period(s): <input type="text" name="subTime">
            </div>
        </div>

        <!-- 行政部分 -->
        <div id="adminSection" style="display:none">
            <fieldset>
                <legend class="title">職務代理人 Substitute</legend>
                <input type="text" name="adminAgent" placeholder="請輸入職務代理人">
            </fieldset>
        </div>

        <br>
        <button type="submit">送出 Submit</button>
    </form>

    <!-- 浮層 -->
    <div id="overlay">
        <div id="modal">
            <h2 style="color:#1E2E5E;">正在傳送您的申請中...</h2>
            <p>Submitting your leave request, please wait...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- ✅ 新增：自動注入 Web App URL -->
    <script>
        const SCRIPT_URL = '<?= execUrl ?>';
    </script>

    <script>
        let isPartial = false;
        let selectedDates = [];

        const form = document.getElementById("leaveForm");
        const fullRadio = document.getElementById('leaveFullRadio');
        const partialRadio = document.getElementById('leavePartialRadio');
        const dateInput = document.getElementById('multiDatePicker');
        const hint = document.getElementById('dateHint');
        const overlay = document.getElementById('overlay');
        const modal = document.getElementById('modal');

        // 初始化 flatpickr
        const fp = flatpickr("#multiDatePicker", {
            mode: "multiple",
            dateFormat: "Y-m-d",
            onChange: function (dates) {
                selectedDates = dates;
                renderTimeRows();
            }
        });

        fullRadio.addEventListener('change', handleSpanTypeChange);
        partialRadio.addEventListener('change', handleSpanTypeChange);

        function handleSpanTypeChange() {
            isPartial = partialRadio.checked;
            hint.style.display = 'block';
            dateInput.style.display = 'inline-block';
            renderTimeRows();
        }

        function renderTimeRows() {
            const container = document.getElementById("dateTimeFields");
            container.innerHTML = "";
            if (!isPartial || selectedDates.length === 0) return;

            selectedDates.forEach(date => {
                const iso = date.toISOString().split("T")[0];
                const display = date.toLocaleDateString();
                const group = document.createElement("div");
                group.className = "date-time-group";
                group.innerHTML = `
          <label class="content">
            <strong>${display}</strong> 請假時間：
            <input type="time" name="startTime_${iso}" class="time-input" required>
            ～ <input type="time" name="endTime_${iso}" class="time-input" required>
          </label>`;
                container.appendChild(group);
            });
        }

        // 教師 / 行政 切換
        function toggleAgentSection() {
            const isTeacher = document.querySelector('input[name="position"][value="Teacher"]').checked;
            document.getElementById("teacherSection").style.display = isTeacher ? "block" : "none";
            document.getElementById("adminSection").style.display = isTeacher ? "none" : "block";
        }

        function toggleSubOptions() {
            const subOption = document.querySelector('input[name="subOption"]:checked')?.value;
            document.getElementById("rescheduleSection").style.display = subOption === "Reschedule" ? "block" : "none";
            document.getElementById("subTeacherSection").style.display = subOption === "Sub Teacher" ? "block" : "none";
        }

        // 上傳檔案大小限制
        document.getElementById("fileInput").addEventListener("change", function () {
            const file = this.files[0];
            if (file && file.size > 2 * 1024 * 1024) {
                alert("⚠ 上傳檔案超過 2MB，請壓縮或重新選擇。");
                this.value = "";
            }
        });

        // --- ✅ 改良後送出表單 ---
        form.addEventListener("submit", async function (e) {
            e.preventDefault();

            // 日期驗證
            const today = new Date();
            const nowDateOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            for (let date of selectedDates) {
                const dateOnly = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                if (dateOnly < nowDateOnly) {
                    alert("⚠ 為已過去日期補請假手續，請採用紙本申請。");
                    return;
                }
            }

            overlay.style.display = "flex";
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbypFDQCFBxvl2hZAhTbvmhaNmz2pJkZda7IW-QY_r4-hcMdoxw8-nT6VzEvwJEgQYfA9g/exec";
                const response = await fetch(SCRIPT_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data),
                });
                const res = await response.json();
                if (res.success) {
                    modal.innerHTML = `
            <h2 style="color:#1E2E5E;">✅ 申請已成功送出！</h2>
            <p>您的請假申請已成功提交，系統已寄出確認信至您的電子郵件信箱。</p>
            <hr style="margin:20px 0;">
            <p>Leave request successfully submitted.<br>
            A confirmation email has been sent to your address.</p>
            <button onclick="location.reload()" style="margin-top:20px;padding:8px 16px;background:#1E2E5E;color:white;border:none;border-radius:6px;">返回表單 Return to Form</button>`;
                } else {
                    modal.innerHTML = `<h2 style="color:#B20000;">⚠ 系統錯誤</h2><p>${res.message}</p>`;
                }
            } catch (err) {
                modal.innerHTML = `<h2 style="color:#B20000;">⚠ 無法連線到伺服器</h2><p>${err}</p>`;
            }
        });
    </script>
</body>

</html>